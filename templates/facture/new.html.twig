{% extends 'base.html.twig' %}

{% block title %}Créer une facture
{% endblock %}

{% block body %}
	<h1 class="text-2xl font-semibold mb-6">Créer une nouvelle facture</h1>

	<form
		method="post" class="bg-white shadow rounded px-8 pt-6 pb-8 mb-6 space-y-6">

		<!-- ✅ Informations générales -->
		<div>
			<h2 class="text-lg font-semibold mb-3">Informations générales</h2>
			<div class="grid grid-cols-2 gap-4">
				<div>
					<label class="block">Numéro de facture</label>
					<input type="text" name="numeroFacture" class="w-full border rounded px-2 py-1">
				</div>
				<div>
					<label class="block">Date de facture</label>
					<input type="date" name="dateFacture" class="w-full border rounded px-2 py-1">
				</div>
				<div>
					<label class="block">Type de facture</label>
					<input type="text" name="typeFacture" class="w-full border rounded px-2 py-1">
				</div>
				<div>
					<label class="block">Devise</label>
					<input type="text" name="devise" value="EUR" class="w-full border rounded px-2 py-1">
				</div>
			</div>
		</div>

		<!-- ✅ Fournisseur / Acheteur -->
		<div class="grid grid-cols-2 gap-8">
			<div>
				<h2 class="text-lg font-semibold mb-3">Fournisseur</h2>
				<div class="space-y-2">
					<input type="text" name="nomFournisseur" placeholder="Nom fournisseur" class="w-full border rounded px-2 py-1">
					<input type="text" name="sirenFournisseur" placeholder="SIREN" class="w-full border rounded px-2 py-1">
					<input type="text" name="siretFournisseur" placeholder="SIRET" class="w-full border rounded px-2 py-1">
					<input type="text" name="tvaFournisseur" placeholder="N° TVA" class="w-full border rounded px-2 py-1">
					<input type="text" name="adresseFournisseur" placeholder="Adresse" class="w-full border rounded px-2 py-1">
					<input type="text" name="villeFournisseur" placeholder="Ville" class="w-full border rounded px-2 py-1">
					<input type="text" name="codePostalFournisseur" placeholder="Code postal" class="w-full border rounded px-2 py-1">
					<input type="text" name="codePaysFournisseur" placeholder="Pays (ex: FR)" class="w-full border rounded px-2 py-1">
					<input type="email" name="emailFournisseur" placeholder="Email" class="w-full border rounded px-2 py-1">
				</div>
			</div>

			<div>
				<h2 class="text-lg font-semibold mb-3">Acheteur</h2>
				<div class="space-y-2">
					<input type="text" name="nomAcheteur" placeholder="Nom acheteur" class="w-full border rounded px-2 py-1">
					<input type="text" name="sirenAcheteur" placeholder="SIREN" class="w-full border rounded px-2 py-1">
					<input type="text" name="tvaAcheteur" placeholder="N° TVA" class="w-full border rounded px-2 py-1">
					<input type="text" name="adresseAcheteur" placeholder="Adresse" class="w-full border rounded px-2 py-1">
					<input type="text" name="villeAcheteur" placeholder="Ville" class="w-full border rounded px-2 py-1">
					<input type="text" name="codePostalAcheteur" placeholder="Code postal" class="w-full border rounded px-2 py-1">
					<input type="text" name="codePaysAcheteur" placeholder="Pays (ex: FR)" class="w-full border rounded px-2 py-1">
					<input type="email" name="emailAcheteur" placeholder="Email" class="w-full border rounded px-2 py-1">
				</div>
			</div>
		</div>

		<!-- ✅ Lignes de facture -->
		<div>
			<h2 class="text-lg font-semibold mb-3">Lignes de facture</h2>
			<div id="lignes-container" class="space-y-4">
				<div class="ligne-facture grid grid-cols-6 gap-2">
					<input type="text" name="lignes[0][designation]" placeholder="Désignation" class="col-span-2 border rounded px-2 py-1">
					<input type="text" name="lignes[0][reference]" placeholder="Réf." class="border rounded px-2 py-1">
					<input type="number" step="0.01" name="lignes[0][quantite]" placeholder="Qté" class="border rounded px-2 py-1">
					<input type="text" name="lignes[0][unite]" placeholder="Unité" class="border rounded px-2 py-1">
					<input type="number" step="0.01" name="lignes[0][prixUnitaireHT]" placeholder="Prix HT" class="border rounded px-2 py-1">
					<input type="number" step="0.01" name="lignes[0][tauxTVA]" placeholder="TVA %" class="border rounded px-2 py-1">
				</div>
			</div>
			<button type="button" id="add-ligne" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded">+ Ajouter ligne</button>
		</div>

		<!-- ✅ Totaux -->
		<div>
			<h2 class="text-lg font-semibold mb-3">Totaux</h2>
			<div class="grid grid-cols-2 gap-4">
				<input type="number" step="0.01" id="totalHT" name="totalHT" placeholder="Total HT" class="w-full border rounded px-2 py-1">
				<input type="number" step="0.01" id="totalTVA" name="totalTVA" placeholder="Total TVA" class="w-full border rounded px-2 py-1">
				<input type="number" step="0.01" id="totalTTC" name="totalTTC" placeholder="Total TTC" class="w-full border rounded px-2 py-1">
				<input type="number" step="0.01" id="netAPayer" name="netAPayer" placeholder="Net à payer" class="w-full border rounded px-2 py-1">
			</div>
		</div>

		<!-- ✅ Paiement -->
		<div>
			<h2 class="text-lg font-semibold mb-3">Paiement</h2>
			<div class="grid grid-cols-2 gap-4">
				<input type="date" name="dateEcheance" placeholder="Date échéance" class="w-full border rounded px-2 py-1">
				<input type="date" name="dateLivraison" placeholder="Date livraison" class="w-full border rounded px-2 py-1">
				<input type="text" name="modePaiement" placeholder="Mode de paiement" class="w-full border rounded px-2 py-1">
				<input type="text" name="referencePaiement" placeholder="Référence paiement" class="w-full border rounded px-2 py-1">
			</div>
		</div>

		<!-- ✅ Factur-X -->
		<div>
			<h2 class="text-lg font-semibold mb-3">Factur-X</h2>
			<select name="profilFacturX" class="w-full border rounded px-2 py-1">
				<option value="MINIMUM">Minimum</option>
				<option value="BASIC">Basic</option>
				<option value="EN16931" selected>EN16931 (Complet)</option>
				<option value="EXTENDED">Extended</option>
			</select>
		</div>

		<!-- ✅ Bouton Submit -->
		<div class="text-right">
			<button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Créer la facture</button>
		</div>
	</form>

	<script>
		document.getElementById('add-ligne').addEventListener('click', function () {
const container = document.getElementById('lignes-container');
const index = container.querySelectorAll('.ligne-facture').length;
const ligne = document.createElement('div');
ligne.classList.add('ligne-facture', 'grid', 'grid-cols-6', 'gap-2');
ligne.innerHTML = `
        <input type="text" name="lignes[${index}][designation]" placeholder="Désignation" class="col-span-2 border rounded px-2 py-1">
        <input type="text" name="lignes[${index}][reference]" placeholder="Réf." class="border rounded px-2 py-1">
        <input type="number" step="0.01" name="lignes[${index}][quantite]" placeholder="Qté" class="border rounded px-2 py-1">
        <input type="text" name="lignes[${index}][unite]" placeholder="Unité" class="border rounded px-2 py-1">
        <input type="number" step="0.01" name="lignes[${index}][prixUnitaireHT]" placeholder="Prix HT" class="border rounded px-2 py-1">
        <input type="number" step="0.01" name="lignes[${index}][tauxTVA]" placeholder="TVA %" class="border rounded px-2 py-1">
    `;
container.appendChild(ligne);
calculerTotaux();
});

document.addEventListener('input', function (e) {
if (e.target.closest('.ligne-facture')) {
calculerTotaux();
}
});

function calculerTotaux() {
let totalHT = 0;
let totalTVA = 0;

document.querySelectorAll('.ligne-facture').forEach(ligne => {
const qte = parseFloat(ligne.querySelector('[name*="[quantite]"]').value) || 0;
const prix = parseFloat(ligne.querySelector('[name*="[prixUnitaireHT]"]').value) || 0;
const tva = parseFloat(ligne.querySelector('[name*="[tauxTVA]"]').value) || 0;

const ligneHT = qte * prix;
const ligneTVA = ligneHT * (tva / 100);

totalHT += ligneHT;
totalTVA += ligneTVA;
});

const totalTTC = totalHT + totalTVA;

document.getElementById('totalHT').value = totalHT.toFixed(2);
document.getElementById('totalTVA').value = totalTVA.toFixed(2);
document.getElementById('totalTTC').value = totalTTC.toFixed(2);
document.getElementById('netAPayer').value = totalTTC.toFixed(2);
}
	</script>
{% endblock %}

